<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGR</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; padding: 0 20px; }
        #api-key { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; }
        #messages { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        #input-area { display: flex; }
        #message-input { flex: 1; padding: 8px; }
        button { padding: 8px 15px; margin-left: 5px; }
        .user-message { text-align: right; color: blue; margin: 5px 0; }
        .ai-message { text-align: left; color: green; margin: 5px 0; }
    </style>
</head>
<body>
    <h2>ChatGR</h2>
    <input type="password" id="api-key" placeholder="在这里粘贴你的 API 密钥" value="">
    <div id="messages"></div>
    <div id="input-area">
        <input type="text" id="message-input" placeholder="向 AI 发送消息" disabled>
        <button id="send-btn" disabled>发送</button>
    </div>

    <script>
        const apiKeyInput = document.getElementById('api-key');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        // 当用户输入密钥后，启用聊天
        apiKeyInput.addEventListener('input', () => {
            const key = apiKeyInput.value.trim();
            if (key.startsWith('sk-')) {
                messageInput.disabled = false;
                sendBtn.disabled = false;
            } else {
                messageInput.disabled = true;
                sendBtn.disabled = true;
            }
        });

        sendBtn.addEventListener('click', async () => {
            const userMessage = messageInput.value.trim();
            if (!userMessage) return;

            // 显示用户消息
            appendMessage('user', userMessage);
            messageInput.value = '';

            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                appendMessage('ai', '请先输入有效的 API 密钥。');
                return;
            }

            // 调用 API（流式输出）
            try {
                const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: userMessage }],
                        stream: true  // 开启流式输出
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.status}`);
                }

                // 处理流式响应（逐块读取）
                const reader = response.body.getReader();
                const decoder = new TextDecoder('utf-8');
                let aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'ai-message';
                messagesDiv.appendChild(aiMessageDiv);
                let fullContent = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim() !== '');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;
                            try {
                                const json = JSON.parse(data);
                                const content = json.choices[0]?.delta?.content || '';
                                fullContent += content;
                                aiMessageDiv.textContent = fullContent;
                            } catch (e) {
                                console.warn('解析错误', e);
                            }
                        }
                    }
                }
            } catch (error) {
                appendMessage('ai', `错误：${error.message}`);
            }
        });

        function appendMessage(role, content) {
            const div = document.createElement('div');
            div.className = role === 'user' ? 'user-message' : 'ai-message';
            div.textContent = content;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>